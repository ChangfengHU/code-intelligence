# ä»£ç é—®ç­”åŠ©æ‰‹æŠ€æœ¯æ–¹æ¡ˆ

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 æ ¸å¿ƒåŠŸèƒ½
- **ä¸€çº§èœå•**ï¼šä»£ç å¯¹è¯
- **äºŒçº§èœå•**ï¼šé—®ç­”åŠ©æ‰‹
- **æ™ºèƒ½åˆ†æ**ï¼šé’ˆå¯¹æ¡†é€‰ä»£ç è¿›è¡Œæ·±åº¦åˆ†æï¼Œç»“åˆPSIè·å–ä¸Šä¸‹æ–‡ä¿¡æ¯
- **å¤šè½®å¯¹è¯**ï¼šæ”¯æŒè¿ç»­é—®ç­”ï¼Œä¿æŒä¸Šä¸‹æ–‡è®°å¿†
- **ä¼šè¯ç®¡ç†**ï¼šæŒ‰ç±»å…¨é™å®šè·¯å¾„ç®¡ç†ä¼šè¯ï¼Œæ”¯æŒå†å²è®°å½•
- **é¦–æ¬¡é»˜è®¤é—®ç­”**ï¼šå¯åŠ¨æ—¶è‡ªåŠ¨è¿›è¡Œä¸€æ¬¡ä»£ç åˆ†æ

### 1.2 æŠ€æœ¯ç‰¹æ€§
- ä½¿ç”¨PSI APIè·å–ä»£ç ç»“æ„å’Œè°ƒç”¨é“¾ä¿¡æ¯
- æ”¯æŒç³»ç»Ÿæç¤ºè¯åå°é…ç½®
- æœ¬åœ°æŒä¹…åŒ–å­˜å‚¨ä¼šè¯å†å²
- å¯é…ç½®çš„ä¼šè¯å’Œæ¶ˆæ¯æ•°é‡é™åˆ¶

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UI Layer      â”‚    â”‚  Service Layer  â”‚    â”‚ Storage Layer   â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ - é—®ç­”å¯¹è¯æ¡†    â”‚â—„â”€â”€â–ºâ”‚ - é—®ç­”æœåŠ¡      â”‚â—„â”€â”€â–ºâ”‚ - ä¼šè¯å­˜å‚¨      â”‚
â”‚ - ä¼šè¯å†å²é¢æ¿  â”‚    â”‚ - PSIåˆ†ææœåŠ¡   â”‚    â”‚ - é…ç½®å­˜å‚¨      â”‚
â”‚ - é…ç½®ç•Œé¢      â”‚    â”‚ - AIå¯¹è¯æœåŠ¡    â”‚    â”‚ - æ¶ˆæ¯å­˜å‚¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¨¡å—

#### 2.2.1 UIå±‚
- `CodeChatDialog`: ä¸»è¦é—®ç­”å¯¹è¯æ¡†
- `SessionHistoryPanel`: ä¼šè¯å†å²é¢æ¿
- `MessageComponent`: å•æ¡æ¶ˆæ¯æ˜¾ç¤ºç»„ä»¶
- `ConfigPanel`: é—®ç­”åŠ©æ‰‹é…ç½®é¢æ¿

#### 2.2.2 æœåŠ¡å±‚
- `CodeChatService`: é—®ç­”æœåŠ¡æ ¸å¿ƒ
- `PSIContextAnalyzer`: PSIä»£ç ä¸Šä¸‹æ–‡åˆ†æ
- `SessionManager`: ä¼šè¯ç®¡ç†æœåŠ¡
- `AIConversationService`: AIå¯¹è¯æœåŠ¡

#### 2.2.3 å­˜å‚¨å±‚
- `ChatSessionStorage`: ä¼šè¯å­˜å‚¨
- `ChatConfigStorage`: é…ç½®å­˜å‚¨
- `ChatHistoryStorage`: æ¶ˆæ¯å†å²å­˜å‚¨

## 3. æ•°æ®æ¨¡å‹

### 3.1 ä¼šè¯æ¨¡å‹
```kotlin
data class ChatSession(
    val id: String,                    // ä¼šè¯ID
    val className: String,             // ç±»å…¨é™å®šè·¯å¾„
    val filePath: String,              // æ–‡ä»¶è·¯å¾„
    val createdAt: Long,               // åˆ›å»ºæ—¶é—´
    val lastActiveAt: Long,            // æœ€åæ´»è·ƒæ—¶é—´
    val messages: MutableList<ChatMessage> = mutableListOf(),
    val metadata: Map<String, Any> = emptyMap()
)
```

### 3.2 æ¶ˆæ¯æ¨¡å‹
```kotlin
data class ChatMessage(
    val id: String,                    // æ¶ˆæ¯ID
    val type: MessageType,             // æ¶ˆæ¯ç±»å‹
    val content: String,               // æ¶ˆæ¯å†…å®¹
    val timestamp: Long,               // æ—¶é—´æˆ³
    val codeContext: CodeContext? = null,  // ä»£ç ä¸Šä¸‹æ–‡
    val metadata: Map<String, Any> = emptyMap()
)

enum class MessageType {
    USER,           // ç”¨æˆ·æ¶ˆæ¯
    ASSISTANT,      // AIåŠ©æ‰‹æ¶ˆæ¯
    SYSTEM,         // ç³»ç»Ÿæ¶ˆæ¯
    CODE_ANALYSIS   // ä»£ç åˆ†ææ¶ˆæ¯
}
```

### 3.3 ä»£ç ä¸Šä¸‹æ–‡æ¨¡å‹
```kotlin
data class CodeContext(
    val selectedCode: String,          // æ¡†é€‰çš„ä»£ç 
    val selectedRange: TextRange,      // é€‰ä¸­èŒƒå›´
    val className: String,             // å½“å‰ç±»å
    val methodName: String?,           // å½“å‰æ–¹æ³•å
    val classContext: String,          // æ•´ä¸ªç±»çš„ä»£ç 
    val imports: List<String>,         // å¯¼å…¥è¯­å¥
    val dependencies: List<DependencyInfo>, // ä¾èµ–ä¿¡æ¯
    val callChain: List<CallInfo>      // è°ƒç”¨é“¾ä¿¡æ¯
)

data class DependencyInfo(
    val className: String,             // ä¾èµ–ç±»å
    val methods: List<String>,         // ç›¸å…³æ–¹æ³•
    val code: String                   // ç›¸å…³ä»£ç ç‰‡æ®µ
)

data class CallInfo(
    val className: String,             // è°ƒç”¨çš„ç±»
    val methodName: String,            // è°ƒç”¨çš„æ–¹æ³•
    val code: String                   // æ–¹æ³•ä»£ç 
)
```

## 4. æ ¸å¿ƒåŠŸèƒ½å®ç°

### 4.1 PSIä¸Šä¸‹æ–‡åˆ†æ
```kotlin
class PSIContextAnalyzer {
    fun analyzeContext(
        file: PsiFile, 
        selectionRange: TextRange
    ): CodeContext {
        // 1. è·å–é€‰ä¸­ä»£ç 
        // 2. åˆ†æå½“å‰ç±»å’Œæ–¹æ³•
        // 3. è·å–importså’Œä¾èµ–
        // 4. åˆ†æè°ƒç”¨é“¾
        // 5. æ„å»ºå®Œæ•´ä¸Šä¸‹æ–‡
    }
    
    private fun findCallChain(element: PsiElement): List<CallInfo>
    private fun findDependencies(psiClass: PsiClass): List<DependencyInfo>
    private fun extractClassContext(psiClass: PsiClass): String
}
```

### 4.2 ä¼šè¯ç®¡ç†
```kotlin
class SessionManager {
    // ä¼šè¯é™åˆ¶é…ç½®
    private var maxSessions: Int = 100
    private var maxMessagesPerSession: Int = 50
    
    fun getOrCreateSession(className: String, filePath: String): ChatSession
    fun addMessage(sessionId: String, message: ChatMessage)
    fun cleanupOldSessions()
    fun cleanupOldMessages(sessionId: String)
    fun getAllSessions(): List<ChatSession>
    fun deleteSession(sessionId: String)
}
```

### 4.3 AIå¯¹è¯æœåŠ¡
```kotlin
class AIConversationService {
    private var systemPrompt: String = getDefaultSystemPrompt()
    
    suspend fun sendMessage(
        message: String,
        codeContext: CodeContext,
        conversationHistory: List<ChatMessage>
    ): String {
        // 1. æ„å»ºå®Œæ•´çš„æç¤ºè¯
        // 2. åŒ…å«ä»£ç ä¸Šä¸‹æ–‡
        // 3. åŒ…å«å¯¹è¯å†å²
        // 4. å‘é€åˆ°AIæœåŠ¡
        // 5. å¤„ç†å“åº”
    }
    
    private fun buildContextPrompt(context: CodeContext): String
    private fun buildConversationHistory(messages: List<ChatMessage>): String
}
```

## 5. UIè®¾è®¡

### 5.1 ä¸»å¯¹è¯æ¡†
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»£ç é—®ç­”åŠ©æ‰‹ - MainActivity.java               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“„ ä¼šè¯å†å²  ğŸ”§ è®¾ç½®                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ ğŸ¤– åŠ©æ‰‹: æˆ‘æ­£åœ¨åˆ†æä½ é€‰ä¸­çš„ä»£ç ...             â”‚
â”‚                                                 â”‚
â”‚ ğŸ‘¤ ç”¨æˆ·: è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ                 â”‚
â”‚                                                 â”‚
â”‚ ğŸ¤– åŠ©æ‰‹: è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨äº...                   â”‚
â”‚                                                 â”‚
â”‚                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¬ è¯·è¾“å…¥ä½ çš„é—®é¢˜...              [å‘é€] [æ¸…ç©º] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ä¼šè¯å†å²é¢æ¿
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼šè¯å†å²                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ com.example.MainActivity         â”‚
â”‚    â””â”€ 2024-08-27 15:30 (5æ¡æ¶ˆæ¯)  â”‚
â”‚                                     â”‚
â”‚ ğŸ“ com.example.UserService          â”‚
â”‚    â””â”€ 2024-08-27 14:20 (3æ¡æ¶ˆæ¯)  â”‚
â”‚                                     â”‚
â”‚ ğŸ“ com.example.DataProcessor        â”‚
â”‚    â””â”€ 2024-08-27 13:10 (8æ¡æ¶ˆæ¯)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6. é…ç½®ç®¡ç†

### 6.1 é…ç½®é¡¹
```kotlin
data class ChatConfig(
    // AIé…ç½®
    val systemPrompt: String = DEFAULT_SYSTEM_PROMPT,
    val maxTokens: Int = 4000,
    val temperature: Double = 0.3,
    
    // ä¼šè¯é…ç½®
    val maxSessions: Int = 100,
    val maxMessagesPerSession: Int = 50,
    val autoSaveInterval: Int = 30, // ç§’
    
    // UIé…ç½®
    val showTimestamp: Boolean = true,
    val enableCodeHighlight: Boolean = true,
    val dialogWidth: Int = 800,
    val dialogHeight: Int = 600
)
```

### 6.2 é»˜è®¤ç³»ç»Ÿæç¤ºè¯
```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç åˆ†æåŠ©æ‰‹ï¼Œæ“…é•¿åˆ†æJava/Kotlinä»£ç ã€‚è¯·æ ¹æ®ç”¨æˆ·é€‰ä¸­çš„ä»£ç å’Œæä¾›çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè¿›è¡Œæ·±å…¥åˆ†æå’Œè§£ç­”ã€‚

ä¸Šä¸‹æ–‡ä¿¡æ¯åŒ…æ‹¬ï¼š
1. ç”¨æˆ·é€‰ä¸­çš„ä»£ç ç‰‡æ®µ
2. å½“å‰ç±»çš„å®Œæ•´ä»£ç 
3. ç›¸å…³çš„å¯¼å…¥è¯­å¥
4. ä¾èµ–çš„ç±»å’Œæ–¹æ³•
5. è°ƒç”¨é“¾è·¯ä¿¡æ¯

è¯·ä»¥ä¸“ä¸šã€å‡†ç¡®ã€æ˜“æ‡‚çš„æ–¹å¼å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å¦‚æœéœ€è¦ï¼Œå¯ä»¥ï¼š
- è§£é‡Šä»£ç çš„åŠŸèƒ½å’Œå®ç°åŸç†
- åˆ†æä»£ç çš„è®¾è®¡æ¨¡å¼å’Œæœ€ä½³å®è·µ
- æŒ‡å‡ºæ½œåœ¨çš„é—®é¢˜æˆ–æ”¹è¿›å»ºè®®
- è§£é‡Šä¸å…¶ä»–ç±»çš„äº¤äº’å…³ç³»

å›ç­”è¯·ä½¿ç”¨ä¸­æ–‡ï¼Œä¿æŒç®€æ´æ˜äº†ã€‚
```

## 7. å­˜å‚¨è®¾è®¡

### 7.1 æ–‡ä»¶ç»“æ„
```
~/.code-assistant/
â”œâ”€â”€ chat/
â”‚   â”œâ”€â”€ sessions/
â”‚   â”‚   â”œâ”€â”€ session_001.json
â”‚   â”‚   â”œâ”€â”€ session_002.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ messages/
â”‚   â”‚   â”œâ”€â”€ session_001_messages.json
â”‚   â”‚   â”œâ”€â”€ session_002_messages.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ index.json
â”œâ”€â”€ config/
â”‚   â””â”€â”€ chat_config.json
â””â”€â”€ logs/
    â””â”€â”€ chat.log
```

### 7.2 ç´¢å¼•æ–‡ä»¶
```json
{
  "sessions": [
    {
      "id": "session_001",
      "className": "com.example.MainActivity",
      "filePath": "/path/to/MainActivity.java",
      "createdAt": 1692345600000,
      "lastActiveAt": 1692349200000,
      "messageCount": 5
    }
  ],
  "totalSessions": 1,
  "lastCleanup": 1692345600000
}
```

## 8. å®ç°è®¡åˆ’

### 8.1 ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¡†æ¶
- [ ] åˆ›å»ºåŸºç¡€æ•°æ®æ¨¡å‹
- [ ] å®ç°ä¼šè¯ç®¡ç†æœåŠ¡
- [ ] åˆ›å»ºåŸºç¡€UIå¯¹è¯æ¡†
- [ ] å®ç°åŸºæœ¬çš„æ¶ˆæ¯æ”¶å‘

### 8.2 ç¬¬äºŒé˜¶æ®µï¼šPSIé›†æˆ
- [ ] å®ç°PSIä¸Šä¸‹æ–‡åˆ†æå™¨
- [ ] é›†æˆä»£ç ä¸Šä¸‹æ–‡åˆ°å¯¹è¯
- [ ] å®ç°è°ƒç”¨é“¾åˆ†æ
- [ ] ä¼˜åŒ–ä»£ç ç†è§£èƒ½åŠ›

### 8.3 ç¬¬ä¸‰é˜¶æ®µï¼šå­˜å‚¨å’Œé…ç½®
- [ ] å®ç°ä¼šè¯æŒä¹…åŒ–å­˜å‚¨
- [ ] æ·»åŠ é…ç½®ç®¡ç†åŠŸèƒ½
- [ ] å®ç°ä¼šè¯å†å²ç®¡ç†
- [ ] æ·»åŠ æ¸…ç†å’Œç»´æŠ¤åŠŸèƒ½

### 8.4 ç¬¬å››é˜¶æ®µï¼šUIä¼˜åŒ–
- [ ] ä¼˜åŒ–å¯¹è¯ç•Œé¢ä½“éªŒ
- [ ] æ·»åŠ ä¼šè¯å†å²é¢æ¿
- [ ] å®ç°ä»£ç é«˜äº®æ˜¾ç¤º
- [ ] æ·»åŠ å¯¼å‡ºå’Œåˆ†äº«åŠŸèƒ½

## 9. æŠ€æœ¯éš¾ç‚¹

### 9.1 PSIåˆ†æå¤æ‚åº¦
- **æŒ‘æˆ˜**ï¼šå‡†ç¡®åˆ†æè°ƒç”¨é“¾å’Œä¾èµ–å…³ç³»
- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨IntelliJ PSI APIçš„å¼•ç”¨è§£æåŠŸèƒ½

### 9.2 ä¸Šä¸‹æ–‡ç®¡ç†
- **æŒ‘æˆ˜**ï¼šå¹³è¡¡ä¸Šä¸‹æ–‡ä¿¡æ¯çš„å®Œæ•´æ€§å’ŒAI tokené™åˆ¶
- **è§£å†³æ–¹æ¡ˆ**ï¼šæ™ºèƒ½è£å‰ªå’Œä¼˜å…ˆçº§æ’åº

### 9.3 ä¼šè¯æŒä¹…åŒ–æ€§èƒ½
- **æŒ‘æˆ˜**ï¼šå¤§é‡ä¼šè¯æ•°æ®çš„å­˜å‚¨å’Œæ£€ç´¢æ€§èƒ½
- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç´¢å¼•æ–‡ä»¶å’Œå»¶è¿ŸåŠ è½½

### 9.4 å†…å­˜ç®¡ç†
- **æŒ‘æˆ˜**ï¼šé•¿æœŸè¿è¡Œæ—¶çš„å†…å­˜å ç”¨
- **è§£å†³æ–¹æ¡ˆ**ï¼šå®šæœŸæ¸…ç†å’Œå¼±å¼•ç”¨ç®¡ç†

## 10. æ‰©å±•æ€§è€ƒè™‘

### 10.1 å¤šè¯­è¨€æ”¯æŒ
- è®¾è®¡é€šç”¨çš„PSIåˆ†ææ¥å£
- æ”¯æŒä¸åŒç¼–ç¨‹è¯­è¨€çš„ç‰¹å®šåˆ†æå™¨

### 10.2 AIæ¨¡å‹åˆ‡æ¢
- æŠ½è±¡AIæœåŠ¡æ¥å£
- æ”¯æŒå¤šç§AIæœåŠ¡æä¾›å•†

### 10.3 æ’ä»¶é›†æˆ
- æä¾›APIä¾›å…¶ä»–æ’ä»¶é›†æˆ
- æ”¯æŒè‡ªå®šä¹‰åˆ†æå™¨æ³¨å†Œ

---

æ­¤æŠ€æœ¯æ–¹æ¡ˆæ¶µç›–äº†ä»£ç é—®ç­”åŠ©æ‰‹çš„å®Œæ•´è®¾è®¡å’Œå®ç°è®¡åˆ’ã€‚å¦‚æœ‰ä»»ä½•ç–‘é—®æˆ–éœ€è¦è°ƒæ•´çš„åœ°æ–¹ï¼Œè¯·éšæ—¶æå‡ºã€‚